# Evaluation Workflow Template
# Copy this file to create a new evaluation workflow for your purple agent
# Replace all [PLACEHOLDER] values with your specific configuration

name: Evaluation - [EVALUATION_NAME]

on:
  # Trigger on pull requests to main branch
  pull_request:
    branches: [ main ]
    # Only run when files in this evaluation's directory change
    paths:
      - 'evaluations/[EVALUATION_DIR]/**'
      - '.github/workflows/eval-[EVALUATION_NAME].yml'

  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================================================
      # STEP 1: Pull Docker images from GHCR
      # ============================================================================

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull green agent image
        run: |
          # Replace with your green agent image and digest
          # Example: ghcr.io/your-org/green-debate-judge@sha256:abc123...
          docker pull [GREEN_AGENT_IMAGE]@[GREEN_AGENT_DIGEST]
          docker tag [GREEN_AGENT_IMAGE]@[GREEN_AGENT_DIGEST] green-agent:local

      - name: Pull purple agent image
        run: |
          # Replace with your purple agent image and digest
          # Example: ghcr.io/your-username/purple-debater@sha256:def456...
          docker pull [PURPLE_AGENT_IMAGE]@[PURPLE_AGENT_DIGEST]
          docker tag [PURPLE_AGENT_IMAGE]@[PURPLE_AGENT_DIGEST] purple-agent:local

      # ============================================================================
      # STEP 2: Create Docker network
      # ============================================================================

      - name: Create Docker network
        run: docker network create eval-network

      # ============================================================================
      # STEP 3: Start purple agent container(s)
      # ============================================================================

      - name: Start purple agent
        run: |
          docker run -d \
            --name purple-agent \
            --network eval-network \
            -p [PURPLE_AGENT_PORT]:[PURPLE_AGENT_PORT] \
            -e [API_KEY_ENV_VAR]="${{ secrets.[API_KEY_SECRET_NAME] }}" \
            purple-agent:local

          # If your evaluation needs multiple purple agents, start additional containers here
          # Example for debate with pro/con debaters:
          # docker run -d \
          #   --name purple-agent-pro \
          #   --network eval-network \
          #   -p 8081:8080 \
          #   -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
          #   purple-agent:local
          #
          # docker run -d \
          #   --name purple-agent-con \
          #   --network eval-network \
          #   -p 8082:8080 \
          #   -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
          #   purple-agent:local

      # ============================================================================
      # STEP 4: Wait for agents to be healthy
      # ============================================================================

      - name: Wait for purple agent to be healthy
        run: |
          echo "Waiting for purple agent to be ready..."
          for i in {1..30}; do
            # Adjust the health check endpoint as needed
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:[PURPLE_AGENT_PORT]/" 2>/dev/null || echo "000")

            if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "502" ] && [ "$HTTP_CODE" != "503" ]; then
              echo "✓ Purple agent is healthy (HTTP $HTTP_CODE)"
              break
            fi

            if [ $i -eq 30 ]; then
              echo "✗ Purple agent failed to become healthy after 60 seconds"
              docker logs purple-agent
              exit 1
            fi

            echo "Waiting for purple agent... (attempt $i/30, HTTP $HTTP_CODE)"
            sleep 2
          done

      # ============================================================================
      # STEP 5: Run green agent evaluation
      # ============================================================================

      - name: Run evaluation
        run: |
          echo "Running green agent evaluation..."

          # Run the green agent with appropriate environment variables
          # The green agent will orchestrate the evaluation and output results
          docker run --rm \
            --name green-agent \
            --network eval-network \
            -e [GREEN_AGENT_CONFIG_VAR]="[CONFIG_VALUE]" \
            -e PURPLE_AGENT_URL="http://purple-agent:[PURPLE_AGENT_PORT]" \
            -e [API_KEY_ENV_VAR]="${{ secrets.[API_KEY_SECRET_NAME] }}" \
            green-agent:local \
            [COMMAND_TO_RUN_EVALUATION] \
            | tee evaluation-results.json

          # Example for debate evaluation:
          # docker run --rm \
          #   --name green-agent \
          #   --network eval-network \
          #   -e TOPIC="Should artificial intelligence be regulated?" \
          #   -e NUM_ROUNDS="3" \
          #   -e PRO_DEBATER_URL="http://purple-agent-pro:8080" \
          #   -e CON_DEBATER_URL="http://purple-agent-con:8080" \
          #   -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
          #   green-agent:local \
          #   python /app/debate_judge.py \
          #   | tee evaluation-results.json

      # ============================================================================
      # STEP 6: Cleanup containers
      # ============================================================================

      - name: Stop and remove containers
        if: always()
        run: |
          echo "Cleaning up containers..."
          docker stop purple-agent || true
          docker rm purple-agent || true
          # Add cleanup for any additional containers you started
          docker network rm eval-network || true

      # ============================================================================
      # STEP 7: Upload results as artifact
      # ============================================================================

      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: evaluation-results-[EVALUATION_NAME]
          path: evaluation-results.json
          retention-days: 30

      - name: Display results summary
        if: always()
        run: |
          echo "=== Evaluation Results ==="
          if [ -f evaluation-results.json ]; then
            cat evaluation-results.json | jq '.' || cat evaluation-results.json
          else
            echo "No results file found"
          fi

# ============================================================================
# PLACEHOLDER REFERENCE GUIDE
# ============================================================================
#
# [EVALUATION_NAME]        - Short name for your evaluation (e.g., "debate", "qa-test")
# [EVALUATION_DIR]         - Directory name in evaluations/ (e.g., "debate-evaluation")
# [GREEN_AGENT_IMAGE]      - GHCR path to green agent (e.g., ghcr.io/org/green-debate-judge)
# [GREEN_AGENT_DIGEST]     - SHA256 digest of green agent image
# [PURPLE_AGENT_IMAGE]     - GHCR path to your purple agent (e.g., ghcr.io/username/purple-debater)
# [PURPLE_AGENT_DIGEST]    - SHA256 digest of purple agent image
# [PURPLE_AGENT_PORT]      - Port your purple agent listens on (e.g., 8080, 9019)
# [API_KEY_ENV_VAR]        - Environment variable name for API key (e.g., GEMINI_API_KEY, OPENAI_API_KEY)
# [API_KEY_SECRET_NAME]    - GitHub Secret name (e.g., GEMINI_API_KEY, OPENAI_API_KEY)
# [GREEN_AGENT_CONFIG_VAR] - Configuration variables needed by green agent
# [CONFIG_VALUE]           - Values for configuration
# [COMMAND_TO_RUN_EVALUATION] - Command to run inside green agent container
#
